import requests
import serial
import http.client
import json
params = {
    "grant_type": "password",
    "client_id": "3MVG9lsAlIP.W_V9qH7Qv_1pZRQ87bx6wDM3mtz5OEaKyvVXaYdC.VCz1h9m3xqfM3RvYtT4WXt5TbsEaq8mN", # Consumer Key
    "client_secret": "D109E2FD937B0A1F21BADA5BE2BEC577C00C016B1CDB026EAF2A8E7F6A3996C9", # Consumer Secret
    "username": "rayhane.hamoumi@hotmail.com.devv", # The email you use to login
    "password": "Rayhane1991DBJLpY7AIgcp1F62gPLBMueY" # Concat your password and your security token
}
r = requests.post("https://login.salesforce.com/services/oauth2/token", params=params)
access_token = r.json().get("access_token")
instance_url = r.json().get("instance_url")
print("Access Token:", access_token)
print("Instance URL", instance_url)

conn = http.client.HTTPSConnection("empathetic-raccoon-fp7a5b-dev-ed.lightning.force.com/") 

port ='COM7'
baud = 9600
 
ser = serial.Serial(port, baud, timeout=1);
    # open the serial port

if ser.isOpen():
    print(ser.name + ' is openâ€¦')
        
    while True:
        if ser.inWaiting() >0: 
            print('Receiving From Arduino.....')
            outputInBytes = ser.readline()
            outputInString = bytes.decode(outputInBytes)       
            print('outputInString  ='+ outputInString)

            SensorNameARD ,SensorValueARD =  outputInString.split(':')

            print('Connecting to Salesforce.....')
            headers = {
            'cache-control': "no-cache",
            'postman-token': "3cd0cf91-13de-b32b-e785-20849723d690",
            'content-type': "application/x-www-form-urlencoded"
            }

            conn.request("POST", "/services/oauth2/token?client_id=3MVG9lsAlIP.W_V9qH7Qv_1pZRQ87bx6wDM3mtz5OEaKyvVXaYdC.VCz1h9m3xqfM3RvYtT4WXt5TbsEaq8mN&client_secret=D109E2FD937B0A1F21BADA5BE2BEC577C00C016B1CDB026EAF2A8E7F6A3996C9&grant_type=password&username=rayhane.hamoumi@hotmail.com.devv&password=Rayhane1991", headers=headers)
            

            res = conn.getresponse()
            data = res.read()
            TokenResponse = json.loads(data)

            
            print( TokenResponse  )       
            Token = TokenResponse['access_token']
            print('Access Token =' + Token)

            headers = {
            'content-type': "application/json",
            'authorization': "Bearer " + Token ,
             'cache-control': "no-cache",
            'postman-token': "8c273e2d-38fb-1640-e9b4-6018b19309ca"
            }
            payload = "{\"SensorName\" : \""+SensorNameARD+"\",\"SensorValue\": "+SensorValueARD+"}"
            

            print('Payload Sent to Salesforce ... ' +payload)
            conn.request("POST", "//services/apexrest/Nad_Salesforce_Arduino_IOT", payload, headers)

            res = conn.getresponse()
            data = res.read()

            print('Response Received From Salesforce After Entry...' + data.decode("utf-8"))



